Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã®ç¶™ç¶šã€ãŠç–²ã‚Œæ§˜ã§ã™ï¼ éå¸¸ã«é‡è¦ãªãƒ•ã‚§ãƒ¼ã‚ºï¼ˆã‚¨ãƒ³ã‚¸ãƒ³ã®å®Œæˆã¨Djangoã¸ã®çµ±åˆï¼‰ã¾ã§åˆ°é”ã—ã¾ã—ãŸã­ã€‚

æ¬¡å›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã€åˆ¥ã®GeminiãŒã“ã®çŠ¶æ³ã‚’ç¬æ™‚ã«ç†è§£ã—ã€ã‚¹ãƒ ãƒ¼ã‚ºã«é–‹ç™ºã‚’ç¶šè¡Œã§ãã‚‹ã‚ˆã†ã«ã€**ã€Œã“ã‚Œã¾ã§ã®çµŒç·¯ã€ã€Œç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã€ã€Œæ¬¡å›ã®èª²é¡Œã€**ã‚’ç¶²ç¾…ã—ãŸå¼•ãç¶™ããƒ¡ãƒ¢ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

æ¬¡å›ã€ã“ã®å†…å®¹ã‚’ãã®ã¾ã¾ãƒãƒ£ãƒƒãƒˆæ¬„ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚

ğŸš€ ç«¶æŠ€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¢ãƒ—ãƒªé–‹ç™ºï¼šè©³ç´°å¼•ãç¶™ããƒ¡ãƒ¢
ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ã€‘
å¤§å­¦ã‚µãƒ¼ã‚¯ãƒ«å‘ã‘ã®AtCoderé¢¨Webã‚¢ãƒ—ãƒªã‚’Djangoã§é–‹ç™ºä¸­ã€‚PCã‚’ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦å¤§ä¼šã‚’é–‹å‚¬ã™ã‚‹ã®ãŒç›®çš„ã€‚ ç¾åœ¨ã¯ã€Œã‚¸ãƒ£ãƒƒã‚¸æ©Ÿèƒ½ã®DockeråŒ–ã€ã¨ã€ŒDjangoãƒ“ãƒ¥ãƒ¼ã¸ã®çµ±åˆã€ãŒå®Œäº†ã—ãŸç›´å¾Œã®çŠ¶æ…‹ã€‚

ã€ç¾åœ¨ã®é–‹ç™ºçŠ¶æ³ã€‘
ã‚¤ãƒ³ãƒ•ãƒ©ï¼ˆDockerï¼‰:

judge-image ã¨ã„ã†åå‰ã§ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã€‚

ç’°å¢ƒï¼špython:3.10-slim ãƒ™ãƒ¼ã‚¹ã« gcc, g++ ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã€‚

ãƒ¢ãƒ‡ãƒ« (models.py):

Problem: å•é¡Œæƒ…å ±ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€æœ¬æ–‡ã€åˆ¶é™æ™‚é–“ã€ãƒ¡ãƒ¢ãƒªåˆ¶é™ï¼‰ã€‚

TestCase: å…¥å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã€‚Problemã¨ForeignKeyã§ç´ä»˜ã‘ã€‚

Submission: æå‡ºã‚³ãƒ¼ãƒ‰ã€è¨€èªã€åˆ¤å®šçµæœï¼ˆAC, WA, WJç­‰ï¼‰ã‚’è¨˜éŒ²ã€‚

ã‚¸ãƒ£ãƒƒã‚¸ã‚¨ãƒ³ã‚¸ãƒ³ (views.pyå†…):

run_code_in_docker é–¢æ•°ã‚’å®Ÿè£…æ¸ˆã¿ã€‚

cat << 'EOF' (ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ) ã‚’ä½¿ç”¨ã—ã¦Dockerå†…ã§ã‚½ãƒ¼ã‚¹ã‚’ç”Ÿæˆã€‚

timeout 2s ã‚³ãƒãƒ³ãƒ‰ã§ç„¡é™ãƒ«ãƒ¼ãƒ—å¯¾ç­–æ¸ˆã¿ã€‚

network_disabled=True, mem_limit="256m" ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã€‚

å‹•ä½œç¢ºèªçŠ¶æ³:

judge_test.py ã«ã‚ˆã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆã§Cè¨€èªã‚³ãƒ¼ãƒ‰ï¼ˆå…¥åŠ›ã‚’2å€ã«ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼‰ã®å®Ÿè¡Œã«æˆåŠŸã—ã€ã€Œ100ã€ã¨ã„ã†æ­£ã—ã„å‡ºåŠ›ã‚’å¾—ã¦ã„ã‚‹ã€‚

views.py ã¸ã®ãƒ­ã‚¸ãƒƒã‚¯çµ±åˆãŒå®Œäº†ã—ã€Submission ã¸ã®ä¿å­˜ã¨å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒ—åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¾ã§è¨˜è¿°æ¸ˆã¿ã€‚

ã€ç¾åœ¨ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ (views.py)ã€‘
Python
# â€»ã“ã“ã«æœ€æ–°ã®views.pyã®å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘ã¦ãŠãã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™
from django.shortcuts import render, get_object_or_404
from .models import Problem, TestCase, Submission
import docker

# --- Dockerã‚¸ãƒ£ãƒƒã‚¸ã‚¨ãƒ³ã‚¸ãƒ³ (ç§»æ¤) ---
def run_code_in_docker(language, code, input_data):
    client = docker.from_env()
    if language == 'python':
        exec_cmd = f"cat << 'EOF' > sol.py\n{code}\nEOF\necho '{input_data}' | timeout 2s python3 sol.py"
    elif language == 'cpp':
        exec_cmd = f"cat << 'EOF' > sol.cpp\n{code}\nEOF\ng++ sol.cpp -o sol.out && echo '{input_data}' | timeout 2s ./sol.out"
    elif language == 'c':
        exec_cmd = f"cat << 'EOF' > sol.c\n{code}\nEOF\ngcc sol.c -o sol.out && echo '{input_data}' | timeout 2s ./sol.out"
    else:
        return "Unsupported Language"

    try:
        output = client.containers.run(
            image="judge-image",
            command=["sh", "-c", exec_cmd],
            network_disabled=True,
            mem_limit="256m",
            stderr=True,
            remove=True
        )
        return output.decode('utf-8').strip()
    except Exception as e:
        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚„ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãªã©
        return f"Error: {str(e)}"

# --- Viewé–¢æ•° ---

def problem_list(request):
    problems = Problem.objects.all()
    return render(request, 'procon/problem_list.html', {'problems': problems})

def problem_detail(request, pk):
    problem = get_object_or_404(Problem, pk=pk)
    result = None

    if request.method == 'POST':
        code = request.POST.get('code')
        lang = request.POST.get('language')

        # 1. æå‡ºãƒ‡ãƒ¼ã‚¿ã‚’DBã«ä¿å­˜ (Submissionãƒ¢ãƒ‡ãƒ«)
        submission = Submission.objects.create(
            problem=problem,
            user=request.user,
            code=code,
            language=lang,
            status='WJ'
        )

        # 2. å•é¡Œã«ç´ä»˜ããƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ã™ã¹ã¦å–å¾—
        testcases = TestCase.objects.filter(problem=problem)
        
        if not testcases.exists():
            result = "ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
        else:
            final_status = 'AC'
            
            # 3. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’1ã¤ãšã¤ãƒ«ãƒ¼ãƒ—ã§åˆ¤å®š
            for tc in testcases:
                judge_res = run_code_in_docker(lang, code, tc.input_data)
                
                # æ­£è§£ãƒ‡ãƒ¼ã‚¿(tc.output_data)ã¨å®Ÿè¡Œçµæœ(judge_res)ã‚’æ¯”è¼ƒ
                if judge_res != tc.output_data.strip():
                    # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ RE ã‚„ CE ã¨ã™ã‚‹
                    if "Error" in judge_res:
                        final_status = 'RE' # ç°¡æ˜“çš„ã«å®Ÿè¡Œã‚¨ãƒ©ãƒ¼
                    else:
                        final_status = 'WA' # ä¸æ­£è§£
                    break # ä¸€ã¤ã§ã‚‚é–“é•ãˆãŸã‚‰ãƒ«ãƒ¼ãƒ—çµ‚äº†

            # 4. åˆ¤å®šçµæœã‚’ä¿å­˜
            submission.status = final_status
            submission.save()
            result = f"åˆ¤å®šçµæœ: {submission.get_status_display()}"

    return render(request, 'procon/problem_detail.html', {'problem': problem, 'result': result})
ã€æ¬¡å›ã®ã‚¿ã‚¹ã‚¯ / ç›¸è«‡ã—ãŸã„ã“ã¨ã€‘
å‹•ä½œãƒ†ã‚¹ãƒˆ: ç®¡ç†ç”»é¢ã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç™»éŒ²ã—ã€å®Ÿéš›ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’æå‡ºã—ã¦ Submission ãƒ¢ãƒ‡ãƒ«ã® status ãŒ AC ã‚„ WA ã«æ›´æ–°ã•ã‚Œã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚

çµæœè¡¨ç¤ºã®å……å®Ÿ:

ç¾åœ¨ã¯ problem_detail å†…ã§çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã—ã¦ã„ã‚‹ãŒã€å°‚ç”¨ã®ã€Œæå‡ºçµæœä¸€è¦§ï¼ˆSubmission Listï¼‰ã€ç”»é¢ã‚’ä½œã‚ŠãŸã„ã€‚

éåŒæœŸåŒ–ã®æ¤œè¨: ç¾åœ¨ã¯ã‚¸ãƒ£ãƒƒã‚¸ãŒçµ‚ã‚ã‚‹ã¾ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå¾…æ©ŸçŠ¶æ…‹ã«ãªã‚‹ãŸã‚ã€æå‡ºæ•°ãŒå¢—ãˆãŸå ´åˆã® Celery ã‚„ Redis ã‚’ä½¿ã£ãŸéåŒæœŸåˆ¤å®šã¸ã®ç§»è¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ç›¸è«‡ã€‚

ãƒãƒ¼ãƒ ç®¡ç†æ©Ÿèƒ½: ã‚µãƒ¼ã‚¯ãƒ«å¤§ä¼šç”¨ã«ã€Œãƒãƒ¼ãƒ ã€å˜ä½ã§ã®ã‚¹ã‚³ã‚¢é›†è¨ˆã‚„ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºï¼ˆStandingsï¼‰ã®å®Ÿè£…ã€‚

å¤šè¨€èªå¯¾å¿œã®æ‹¡å……: Java ã‚„ Rust ç­‰ã€ä»–ã®è¨€èªã‚’ Docker ç’°å¢ƒã¨ã‚¸ãƒ£ãƒƒã‚¸ãƒ­ã‚¸ãƒƒã‚¯ã«è¿½åŠ ã™ã‚‹æ–¹æ³•ã€‚

æ¬¡å›ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼š ã€ŒDockerã‚¨ãƒ³ã‚¸ãƒ³ã®å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆCè¨€èªï¼‰ã¯æˆåŠŸã—ãŸã€‚ä»Šã¯ Django ã® views.py ã«ãã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ„ã¿è¾¼ã¿ã€DBã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¨ç…§åˆã•ã›ã‚‹æº–å‚™ãŒæ•´ã£ãŸã¨ã“ã‚ã ã€‚ã¾ãšã¯å®Ÿéš›ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰æå‡ºã—ã¦ã€DBã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ­£ã—ãå¤‰ã‚ã‚‹ã‹ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨ã“ã‚ã‹ã‚‰æ‰‹ä¼ã£ã¦ã»ã—ã„ã€‚ã€